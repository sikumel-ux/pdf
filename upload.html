<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahika Trans Files | Verifikasi Sistem</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --deep-blue: #053a6f; 
            --mahika-yellow: #facc15; 
            --white: #ffffff;
            --light-bg: #f3f4f6;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }
        body { margin: 0; background-color: var(--light-bg); font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }

        /* Header Section */
        .top-section {
            background: radial-gradient(circle at 50% 0%, #074a8d 0%, #053a6f 100%);
            height: 180px; display: flex; flex-direction: column; align-items: center; padding-top: 35px;
        }
        .title-brand { font-size: 32px; font-weight: 800; letter-spacing: -1px; margin: 0; color: var(--white); }
        .brand-mahika { color: var(--mahika-yellow); }
        .subtitle { font-size: 10px; color: var(--mahika-yellow); text-align: center; letter-spacing: 2px; font-weight: 600; margin-top: 5px; text-transform: uppercase; }

        /* Container */
        .main-container { max-width: 400px; margin: -60px auto 40px auto; padding: 0 15px; }

        /* Card Style */
        .search-card { 
            background: var(--white); border-radius: 24px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.1); padding: 25px; 
            transition: all 0.3s ease;
        }

        /* Verifikasi State */
        #verifying-ui { text-align: center; padding: 20px; }
        .spinner { 
            border: 4px solid rgba(5, 58, 111, 0.1); border-left-color: var(--deep-blue); 
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Form Content */
        .form-group { margin-bottom: 18px; position: relative; }
        label { display: block; font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin: 0 0 8px 4px; }

        .file-display-box {
            background-color: #f8fafc; border: 1.5px solid #f1f5f9; padding: 15px;
            border-radius: 12px; display: flex; align-items: center; gap: 12px;
            font-weight: 700; color: var(--deep-blue); font-size: 14px;
        }

        /* Buttons */
        .btn-search {
            width: 100%; padding: 16px; background: var(--deep-blue); color: var(--white); border: none;
            border-radius: 14px; font-weight: 800; font-size: 14px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
        }
        .btn-search:hover { background: #074a8d; transform: translateY(-2px); }
        .btn-search:disabled { background: #94a3b8; cursor: not-allowed; }

        /* Result Item */
        .result-item {
            margin-top: 20px; border-top: 1px solid #f1f5f9; padding-top: 20px;
        }
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800;
            text-transform: uppercase; margin-bottom: 10px;
        }
        .status-success { background: #dcfce7; color: #166534; }
        .status-error { background: #fee2e2; color: #991b1b; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="top-section">
    <h1 class="title-brand">MAHIKA<span class="brand-mahika">TRANS</span></h1>
    <div class="subtitle">Cloud File Manager System</div>
</div>

<div class="main-container">
    <div class="search-card">
        
        <div id="verifying-ui">
            <div class="spinner"></div>
            <p style="font-size: 13px; font-weight: 600; color: var(--deep-blue);">Memverifikasi Izin Akses...</p>
        </div>

        <div id="upload-ui" class="hidden">
            <div class="form-group">
                <label>File Target Terdeteksi</label>
                <div class="file-display-box">
                    <i data-lucide="file-text"></i>
                    <span id="targetFileName">-</span>
                </div>
            </div>

            <div class="form-group">
                <label>Pilih File Pengganti</label>
                <input type="file" id="fileInput" accept="application/pdf" style="padding-left: 15px;">
            </div>

            <button class="btn-search" id="uploadBtn" onclick="executeUpload()">
                <i data-lucide="upload-cloud"></i> UPDATE FILE SEKARANG
            </button>
        </div>

        <div id="error-ui" class="hidden" style="text-align: center;">
            <i data-lucide="shield-alert" style="width: 48px; height: 48px; color: var(--danger); margin-bottom: 15px;"></i>
            <h3 style="color: var(--deep-blue); margin: 0;">Akses Ditolak</h3>
            <p style="font-size: 12px; color: #64748b;">Halaman tidak dapat dibuka karena file tidak ditemukan atau parameter salah.</p>
        </div>

        <div id="result-area" class="hidden result-item">
            <div id="statusBadge" class="status-badge">Berhasil</div>
            <div id="finalMsg" style="font-size: 13px; font-weight: 700; color: var(--deep-blue);"></div>
        </div>

    </div>

    <div class="action-area">
        <div class="action-label">Butuh Bantuan Operasional?</div>
        <a href="https://wa.me/628123456789" class="btn-whatsapp">
            <i data-lucide="message-circle"></i> HUBUNGI ADMIN MAHIKA
        </a>
    </div>
</div>

<script>
    lucide.createIcons();

    const API_URL = "https://script.google.com/macros/s/AKfycbyzNaowGlzUAvsfX0DTnb98BiXM5JkYgK45po94lh2NPj-7rU41QZZ0BV3vBvMFltRFCw/exec";
    const GITHUB_REPO = "USERNAME/REPO_KAMU"; // GANTI INI
    
    let fileSha = "";
    let fileName = "";

    // 1. FUNGSI VALIDASI (METODE 2)
    async function checkSecurity() {
        const params = new URLSearchParams(window.location.search);
        fileName = params.get('file');

        if (!fileName) {
            showError();
            return;
        }

        try {
            // Cek ke GitHub API apakah file ada
            const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/uploads/${fileName}`);
            
            if (res.status === 200) {
                const data = await res.json();
                fileSha = data.sha; // Simpan SHA untuk keperluan update/delete
                showUpload(fileName);
            } else {
                showError();
            }
        } catch (e) {
            showError();
        }
    }

    function showUpload(name) {
        document.getElementById('verifying-ui').classList.add('hidden');
        document.getElementById('upload-ui').classList.remove('hidden');
        document.getElementById('targetFileName').innerText = name;
    }

    function showError() {
        document.getElementById('verifying-ui').classList.add('hidden');
        document.getElementById('error-ui').classList.remove('hidden');
    }

    // 2. FUNGSI UPLOAD (MODERN VERSION)
    async function executeUpload() {
        const input = document.getElementById('fileInput');
        const btn = document.getElementById('uploadBtn');
        if (!input.files[0]) return alert("Pilih file PDF pengganti!");

        btn.disabled = true;
        btn.innerHTML = "Sedang Mengupdate...";

        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "upload",
                        name: fileName,
                        content: reader.result,
                        sha: fileSha // Kirim SHA agar GitHub menimpa file lama
                    })
                });

                const res = await response.json();
                if (res.content) {
                    showFinalResult(true, "File berhasil diperbarui di server Mahika.");
                } else {
                    showFinalResult(false, "Gagal memperbarui file.");
                }
            } catch (err) {
                showFinalResult(false, "Terjadi kesalahan koneksi API.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="upload-cloud"></i> UPDATE FILE SEKARANG';
                lucide.createIcons();
            }
        };
        reader.readAsDataURL(input.files[0]);
    }

    function showFinalResult(isSuccess, msg) {
        const area = document.getElementById('result-area');
        const badge = document.getElementById('statusBadge');
        area.classList.remove('hidden');
        badge.className = isSuccess ? 'status-badge status-success' : 'status-badge status-error';
        badge.innerText = isSuccess ? 'Berhasil' : 'Gagal';
        document.getElementById('finalMsg').innerText = msg;
    }

    // Jalankan validasi saat halaman dimuat
    checkSecurity();

</script>
</body>
</html>
